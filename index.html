<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>El Rey de las Empanadas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
 font-family:Arial,sans-serif;
 background:#f4f4f4;
 margin:0;
 padding:10px;
}
h1{
 text-align:center;
 color:#b30000;
 margin-bottom:5px;
}
h1 small{
 display:block;
 font-size:12px;
 color:#555;
}
.section-title{
 background:#b30000;
 color:white;
 padding:8px 12px;
 border-radius:8px;
 margin-bottom:10px;
 font-size:18px;
}
.card{
 background:white;
 padding:15px;
 border-radius:12px;
 margin-bottom:20px;
 box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.item{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:8px 0;
 border-bottom:1px dashed #eee;
}
.item:last-child{border-bottom:none}
.name{
 font-weight:bold;
 font-size:15px;
}
.desc{
 font-size:12px;
 color:#777;
 margin-top:2px;
}
.controls button{
 width:30px;
 height:30px;
 border:none;
 border-radius:6px;
 font-size:18px;
 cursor:pointer;
}
.controls .plus{background:#25D366;color:white;}
.controls .minus{background:#b30000;color:white;}
.selector{
 display:flex;
 gap:10px;
 margin:10px 0;
}
.selector button{
 flex:1;
 padding:10px;
 font-size:16px;
 border-radius:8px;
 border:1px solid #ccc;
 background:#eee;
 cursor:pointer;
}
.selector button.active{
 background:#b30000;
 color:white;
}
.input-area input, .input-area textarea{
 width:100%;
 padding:8px;
 margin:6px 0;
 font-size:16px;
 border-radius:6px;
 border:1px solid #ccc;
}
.total{
 background:white;
 padding:15px;
 border-radius:12px;
 box-shadow:0 3px 8px rgba(0,0,0,.15);
}
button.send{
 width:100%;
 padding:15px;
 background:#25D366;
 color:white;
 font-size:20px;
 border:none;
 border-radius:12px;
 margin-top:10px;
}
.notice{
 background:#fff3cd;
 color:#856404;
 padding:8px 12px;
 border-radius:6px;
 margin:8px 0;
 font-size:14px;
}
small{color:#777}

/* Marca resaltada */
.brand-card{
 background:#f9f9f9;
 border:1px solid #ddd;
 border-radius:8px;
 padding:8px;
 margin:6px 0;
}
.brand-title{
 font-weight:bold;
 font-size:14px;
 color:#b30000;
 margin-bottom:4px;
}
.brand-item small{
 display:block;
 font-size:12px;
 color:#777;
 margin-top:2px;
}

/* No disponible */
.no-stock{
 color:red;
 font-weight:bold;
}
</style>
</head>

<body>

<h1>üëë El Rey de las Empanadas
<small>Horario: 17:00 a 23:00 | Lunes cerrado | Delivery: 18:30 a 23:00</small>
</h1>

<div id="menu"></div>

<div class="total">
<div class="section-title">üõí Resumen del pedido</div>
<div id="resumen"><small>No hay productos seleccionados</small></div>

<p><b>Total:</b> $<span id="total">0</span></p>
<small>Env√≠o no incluido</small>

<div class="section-title">üöö Forma de entrega</div>
<div class="selector">
<button id="btnMostrador" class="active" onclick="setEntrega('Mostrador')">Retiro en mostrador</button>
<button id="btnDelivery" onclick="setEntrega('Delivery')">Delivery</button>
</div>

<div class="input-area">
<input id="nombre" placeholder="Nombre">
<input id="direccion" placeholder="Direcci√≥n" style="display:none">
<textarea id="observaciones" placeholder="Observaciones sobre la direcci√≥n" style="display:none"></textarea>
</div>

<div class="section-title">üí≥ Forma de pago</div>
<div class="selector">
<button id="btnEfectivo" class="active" onclick="setPago('Efectivo')">Efectivo</button>
<button id="btnTransferencia" onclick="setPago('Transferencia')">Transferencia</button>
</div>

<div id="cambioNotice" class="notice" style="display:block">
<input id="efectivoCambio" placeholder="¬øNecesita cambio?">
</div>

<div id="transferNotice" class="notice" style="display:none">
El enlace de transferencia aparecer√° en WhatsApp. Pedir comprobante.
</div>

<button class="send" onclick="enviar()">üì≤ Enviar pedido</button>

<!-- QR al final -->
<div style="text-align:center; margin-top:20px;">
<p>üì± Escanea para hacer tu pedido</p>
<img id="qrImg" src="" alt="QR C√≥digo Pedido" style="border:3px solid #b30000; padding:10px; border-radius:12px; width:200px;">
<br><br>
<a id="whatsappShare" href="" target="_blank" style="display:inline-block; padding:10px 15px; background:#25D366; color:white; border-radius:8px; text-decoration:none;">Compartir QR por WhatsApp</a>
</div>

<script>
// Configuraci√≥n
let entrega="Mostrador";
let pago="Efectivo";
let carrito={}, precios={}, stock={}, total=0;

// CSV p√∫blico de Google Sheets
const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?gid=0&single=true&output=csv";

function idify(name){ return name.replace(/\s+/g,'_').replace(/[^\w]/g,''); }

async function fetchCSV(){
    const res = await fetch(csvUrl);
    const text = await res.text();
    parseCSV(text);
}

function parseCSV(text){
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    let productos=[];
    for(let i=1;i<lines.length;i++){
        let obj={}, line=lines[i].split(",");
        headers.forEach((h,j)=>obj[h.trim()]=line[j].trim());
        productos.push(obj);
    }
    renderMenu(productos);
}

function renderMenu(productos){
    let html="";
    carrito={}; precios={}; stock={};
    productos.forEach(p=>{
        let pid=idify(p.Producto);
        carrito[pid]=0;
        precios[pid]=parseFloat(p.Precio)||0;
        stock[pid]=(p.Stock.toLowerCase()==="true");
        html+=`<div class="card">
            <div class="item">
                <div>
                    <div class="name">${p.Producto}</div>
                    <div class="desc">${p.Categoria}</div>
                    ${!stock[pid]?`<div class="no-stock">No disponible</div>`:`<small>$${precios[pid]}</small>`}
                </div>
                <div class="controls">
                    <button class="minus" onclick="chg('${pid}',-1)" ${!stock[pid]?'disabled':''}>‚àí</button>
                    <span id="${pid}">0</span>
                    <button class="plus" onclick="chg('${pid}',1)" ${!stock[pid]?'disabled':''}>+</button>
                </div>
            </div>
        </div>`;
    });
    document.getElementById("menu").innerHTML=html;
}

function chg(pid,d){
    if(!stock[pid]) return;
    carrito[pid]+=d;
    if(carrito[pid]<0) carrito[pid]=0;

    document.getElementById(pid).innerText = carrito[pid];

    total=0;
    for(let k in carrito){
        total+=carrito[k]*precios[k];
    }
    document.getElementById("total").innerText = total;

    resumen();
}

function resumen(){
    let r="";
    for(let k in carrito){
        if(carrito[k]>0){
            r+=`${carrito[k]} ${k.replace(/_/g,' ')}<br>`;
        }
    }
    document.getElementById("resumen").innerHTML=r||"<small>No hay productos seleccionados</small>";
}

function setEntrega(t){
    entrega=t;
    document.getElementById("btnMostrador").classList.toggle("active",t=="Mostrador");
    document.getElementById("btnDelivery").classList.toggle("active",t=="Delivery");

    document.getElementById("direccion").style.display=t=="Delivery"?"block":"none";
    document.getElementById("observaciones").style.display=t=="Delivery"?"block":"none";
}

function setPago(p){
    pago=p;
    document.getElementById("btnEfectivo").classList.toggle("active",p=="Efectivo");
    document.getElementById("btnTransferencia").classList.toggle("active",p=="Transferencia");
    document.getElementById("cambioNotice").style.display=p=="Efectivo"?"block":"none";
    document.getElementById("transferNotice").style.display=p=="Transferencia"?"block":"none";
}

function enviar(){
    if(total==0){ alert("Seleccione al menos un producto para realizar el pedido."); return; }
    if(nombre.value.trim()===""){ alert("Ingrese su nombre para el pedido."); return; }

    let msg="üßæ *Pedido - El Rey de las Empanadas*%0A%0A";
    for(let k in carrito){ if(carrito[k]>0) msg+=`‚Ä¢ ${carrito[k]} ${k.replace(/_/g,' ')}%0A`; }
    msg+=`%0Aüí∞ Total: $${total} (env√≠o no incluido)`;
    msg+=`%0Aüöö Entrega: ${entrega}`;
    if(entrega=="Delivery") msg+=`%0Aüìç Direcci√≥n: ${direccion.value}%0Aüìù Observaciones: ${observaciones.value||"No indicadas"}`;
    msg+=`%0Aüë§ Nombre: ${nombre.value}`;
    msg+=`%0Aüí≥ Pago: ${pago}`;
    if(pago=="Transferencia") msg+=`%0Aüìé TRANSFERENCIA: http://transferencia.cccc (Enviar comprobante)`;
    if(pago=="Efectivo" && efectivoCambio.value.trim()!="") msg+=`%0Aüíµ Cambio solicitado: ${efectivoCambio.value}`;
    window.open("https://wa.me/59892663559?text="+msg,"_blank");
}

// Generar QR para la p√°gina
function generarQR(){
    const url=window.location.href;
    const qrUrl="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(url);
    document.getElementById("qrImg").src=qrUrl;
    document.getElementById("whatsappShare").href="https://wa.me/?text="+encodeURIComponent("¬°Hac√© tu pedido aqu√≠! "+url);
}

// Iniciar
fetchCSV();
generarQR();
</script>

</body>
</html>
