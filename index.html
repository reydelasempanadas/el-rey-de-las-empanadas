<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>El Rey de las Empanadas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;padding:10px}
h1{text-align:center;color:#b30000;margin-bottom:5px}
h1 small{display:block;font-size:12px;color:#555}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.section-title{background:#b30000;color:#fff;padding:8px 12px;border-radius:8px;font-size:18px;margin-bottom:10px}
.sub-title{font-weight:bold;color:#b30000;margin:12px 0 6px;border-bottom:1px solid #eee}
.item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
.item:last-child{border-bottom:none}
.name{font-weight:bold}
.desc{font-size:12px;color:#777}
.controls{display:flex;align-items:center;gap:6px}
.controls button{width:30px;height:30px;border:none;border-radius:6px;font-size:18px;color:#fff}
.plus{background:#25D366}
.minus{background:#b30000}
.selector{display:flex;gap:10px;margin:10px 0}
.selector button{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;background:#eee}
.selector button.active{background:#b30000;color:#fff}
.notice{background:#fff3cd;color:#b30000;padding:10px;border-radius:8px;margin:10px 0;text-align:center;font-size:14px}
.input-area input,.input-area textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
button.send{width:100%;padding:15px;background:#25D366;color:#fff;font-size:18px;border:none;border-radius:12px;margin-top:10px}
.qr-box{margin-top:30px;background:#fff;border:3px solid #b30000;border-radius:14px;padding:20px;text-align:center}
.qr-box img{width:220px;display:block;margin:10px auto}
.qr-box a{color:#25D366;font-weight:bold;text-decoration:none}
</style>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const menu = document.getElementById("menu");

let carrito = {};
let precios = {};
let total = 0;
let entrega = "Mostrador";
let pago = "Efectivo";
let productos = [];

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?output=csv";

Papa.parse(CSV_URL,{
  download:true,
  header:true,
  complete:(res)=>{
    const filas = res.data.filter(f =>
      f.Producto &&
      String(f.Disponible).toUpperCase() === "TRUE"
    );

    const map = {};

    filas.forEach(f=>{
      const cat = f.Categoria.trim();
      const sub = (f.Subcategoria || "").trim();
      const prod = f.Producto.trim();
      const desc = f.Descripci√≥n || "";
      const precio = Number(f.Precio) || 0;

      if(!map[cat]) map[cat] = {};
      if(sub && !map[cat][sub]) map[cat][sub] = [];
      if(!sub && !map[cat]["__sin__"]) map[cat]["__sin__"] = [];

      const destino = sub ? map[cat][sub] : map[cat]["__sin__"];
      destino.push({prod, desc, precio});
    });

    productos = map;
    render();
  }
});

function render(){
  let h = "";

  Object.keys(productos).forEach(cat=>{
    h += `<div class="card"><div class="section-title">${cat}</div>`;

    Object.keys(productos[cat]).forEach(sub=>{
      if(sub !== "__sin__")
        h += `<div class="sub-title">${sub}</div>`;

      productos[cat][sub].forEach(p=>{
        const id = p.prod.replace(/\s/g,"_");

        carrito[id] = 0;
        precios[id] = p.precio;

        h += `
        <div class="item">
          <div>
            <div class="name">${p.prod}</div>
            <div class="desc">${p.desc}</div>
          </div>
          <div class="controls">
            <button class="minus" onclick="chg('${id}',-1)">‚àí</button>
            <span id="${id}">0</span>
            <button class="plus" onclick="chg('${id}',1)">+</button>
          </div>
        </div>`;
      });
    });

    h += `</div>`;
  });

  menu.innerHTML = h;
}

function chg(id,d){
  carrito[id] = Math.max(0, carrito[id] + d);
  document.getElementById(id).innerText = carrito[id];

  total = 0;
  for(let k in carrito){
    total += carrito[k] * (precios[k] || 0);
  }

  document.getElementById("total").innerText = total;
  resumen();
}

function resumen(){
  let r = "";
  for(let k in carrito){
    if(carrito[k]){
      r += `${carrito[k]} ${k.replace(/_/g," ")}<br>`;
    }
  }
  document.getElementById("resumen").innerHTML =
    r || "<small>No hay productos seleccionados</small>";
}

function setEntrega(t){
  entrega=t;
  btnMostrador.classList.toggle("active",t==="Mostrador");
  btnDelivery.classList.toggle("active",t==="Delivery");
  direccion.style.display=observaciones.style.display=t==="Delivery"?"block":"none";
  avisoEnvio.style.display=t==="Delivery"?"block":"none";
}

function setPago(p){
  pago=p;
  btnEfectivo.classList.toggle("active",p==="Efectivo");
  btnTransferencia.classList.toggle("active",p==="Transferencia");
  cambioBox.style.display=p==="Efectivo"?"block":"none";
  transferNotice.style.display=p==="Transferencia"?"block":"none";
}

function enviar(){
  if(!total || !nombre.value) return alert("Complete el pedido");

  let msg="üßæ *Pedido El Rey de las Empanadas*%0A";
  for(let k in carrito){
    if(carrito[k])
      msg+=`‚Ä¢ ${carrito[k]} ${k.replace(/_/g," ")}%0A`;
  }

  msg+=`%0Aüí∞ Total: $${total}`;
  if(entrega==="Delivery") msg+=`%0A‚ö†Ô∏è ATENCI√ìN! Enviar costo total con delivery`;
  if(pago==="Transferencia") msg+=`%0A‚ÄºÔ∏è ATENCI√ìN! Enviar enlace de transferencia`;

  window.open("https://wa.me/59892663559?text="+msg,"_blank");
}
</script>
const menu = document.getElementById("menu");
let carrito={}, total=0, entrega="Mostrador", pago="Efectivo";
let productos=[];

const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?output=csv";

Papa.parse(CSV_URL,{
  download:true,
  header:true,
  complete:(res)=>{
    const filas=res.data.filter(f=>String(f.Disponible).toUpperCase()==="TRUE");
    const map={};

    filas.forEach(f=>{
      if(!map[f.Categoria]) map[f.Categoria]={cat:f.Categoria,precio:Number(f.Precio)||0,items:[]};
      if(f.Subcategoria && !map[f.Categoria].items.find(i=>i[0]===f.Subcategoria))
        map[f.Categoria].items.push([f.Subcategoria]);
      map[f.Categoria].items.push([f.Producto,f.Descripci√≥n||""]);
    });

    productos=Object.values(map);
    render();
  }
});

function render(){
let h="";
productos.forEach(s=>{
h+=`<div class="card"><div class="section-title">${s.cat}</div>`;
s.items.forEach(i=>{
if(i.length===1){h+=`<div class="sub-title">${i[0]}</div>`;return;}
let id=i[0].replace(/\s/g,"_");
carrito[id]=0;
h+=`<div class="item">
<div><div class="name">${i[0]}</div><div class="desc">${i[1]}</div></div>
<div class="controls">
<button class="minus" onclick="chg('${id}',-1)">‚àí</button>
<span id="${id}">0</span>
<button class="plus" onclick="chg('${id}',1)">+</button>
</div></div>`;
});
h+="</div>";
});
menu.innerHTML=h;
}

function chg(id,d){
carrito[id]=Math.max(0,carrito[id]+d);
document.getElementById(id).innerText=carrito[id];
total=0;
for(let k in carrito) total+=carrito[k]*60;
totalEl.innerText=total;
resumen();
}

function resumen(){
let r="";
for(let k in carrito) if(carrito[k]) r+=`${carrito[k]} ${k.replace(/_/g," ")}<br>`;
resumen.innerHTML=r||"<small>No hay productos seleccionados</small>";
}

function setEntrega(t){
entrega=t;
btnMostrador.classList.toggle("active",t==="Mostrador");
btnDelivery.classList.toggle("active",t==="Delivery");
direccion.style.display=observaciones.style.display=t==="Delivery"?"block":"none";
avisoEnvio.style.display=t==="Delivery"?"block":"none";
}

function setPago(p){
pago=p;
btnEfectivo.classList.toggle("active",p==="Efectivo");
btnTransferencia.classList.toggle("active",p==="Transferencia");
cambioBox.style.display=p==="Efectivo"?"block":"none";
transferNotice.style.display=p==="Transferencia"?"block":"none";
}

function enviar(){
if(!total||!nombre.value) return alert("Complete el pedido");
let msg="üßæ *Pedido El Rey de las Empanadas*%0A";
for(let k in carrito) if(carrito[k]) msg+=`‚Ä¢ ${carrito[k]} ${k.replace(/_/g," ")}%0A`;
msg+=`%0Aüí∞ Total: $${total}`;
if(entrega==="Delivery") msg+=`%0A‚ö†Ô∏è ATENCI√ìN! Enviar costo total con delivery`;
if(pago==="Transferencia") msg+=`%0A‚ÄºÔ∏è ATENCI√ìN! Enviar enlace de transferencia`;
window.open("https://wa.me/59892663559?text="+msg,"_blank");
}
</script>

</body>
</html>
