<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>El Rey de las Empanadas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;padding:10px}
h1{text-align:center;color:#b30000}
h1 small{display:block;font-size:12px;color:#555}

.section-title{
 background:#b30000;color:white;
 padding:8px 12px;border-radius:8px;
 margin-bottom:10px;font-size:18px;
}

.sub-title{
 font-weight:bold;color:#b30000;
 margin:12px 0 6px;font-size:15px;
 border-bottom:1px solid #eee;
}

.card{
 background:white;padding:15px;
 border-radius:12px;margin-bottom:20px;
 box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.item{
 display:flex;justify-content:space-between;
 align-items:center;padding:8px 0;
 border-bottom:1px dashed #eee;
}

.item:last-child{border-bottom:none}
.name{font-weight:bold}
.desc{font-size:12px;color:#777}

.controls button{
 width:30px;height:30px;border:none;
 border-radius:6px;font-size:18px;cursor:pointer;
}
.plus{background:#25D366;color:white}
.minus{background:#b30000;color:white}

.total{
 background:white;padding:15px;border-radius:12px;
 box-shadow:0 3px 8px rgba(0,0,0,.15);
}

button.send{
 width:100%;padding:15px;background:#25D366;
 color:white;font-size:20px;border:none;
 border-radius:12px;margin-top:10px;
}
</style>
</head>

<body>

<h1>ðŸ‘‘ El Rey de las Empanadas
<small>Horario: 17:00 a 23:00 | Delivery desde 18:30</small>
</h1>

<div id="menu"></div>

<div class="total">
<div class="section-title">ðŸ›’ Resumen</div>
<div id="resumen"><small>No hay productos seleccionados</small></div>
<p><b>Total:</b> $<span id="total">0</span></p>
<button class="send" onclick="enviar()">ðŸ“² Enviar pedido</button>
</div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?output=csv";

let carrito={},precios={},total=0;

// ===== CSV PARSER SEGURO =====
function parseCSV(text){
 let rows=[],row=[],current="",inQuotes=false;
 for(let i=0;i<text.length;i++){
  let c=text[i],n=text[i+1];
  if(c=='"'&&inQuotes&&n=='"'){current+='"';i++;}
  else if(c=='"'){inQuotes=!inQuotes;}
  else if(c==','&&!inQuotes){row.push(current.trim());current="";}
  else if(c=='\n'&&!inQuotes){
    row.push(current.trim());
    rows.push(row);
    row=[];current="";
  } else current+=c;
 }
 row.push(current.trim());
 rows.push(row);
 return rows;
}

// ===== CARGA DE DATOS =====
fetch(CSV_URL)
.then(r=>r.text())
.then(text=>{
 const rows=parseCSV(text);
 const headers=rows[0];
 const data=rows.slice(1);

 const menu={};

 data.forEach(r=>{
  if(r.length<5) return;

  let obj={};
  headers.forEach((h,i)=>obj[h]=r[i]);

  if(!obj.categoria || obj.stock!=="TRUE") return;

  if(!menu[obj.categoria]) menu[obj.categoria]={};
  if(!menu[obj.categoria][obj.subcategoria||""]) menu[obj.categoria][obj.subcategoria||""]=[];

  menu[obj.categoria][obj.subcategoria||""].push(obj);
 });

 render(menu);
})
.catch(err=>{
 console.error("Error cargando menÃº:",err);
 alert("Error cargando el menÃº");
});

// ===== RENDER =====
function render(menu){
 let html="";
 for(let cat in menu){
  html+=`<div class="card"><div class="section-title">${cat}</div>`;
  for(let sub in menu[cat]){
   if(sub) html+=`<div class="sub-title">${sub}</div>`;
   menu[cat][sub].forEach(p=>{
    let id=p.nombre.replace(/\s+/g,"_");
    carrito[id]=0;
    precios[id]=parseInt(p.precio);

    html+=`
    <div class="item">
     <div>
      <div class="name">${p.nombre}</div>
      <div class="desc">${p.descripcion||""}</div>
      <small>$${p.precio}</small>
     </div>
     <div class="controls">
      <button class="minus" onclick="chg('${id}',-1)">âˆ’</button>
      <span id="${id}">0</span>
      <button class="plus" onclick="chg('${id}',1)">+</button>
     </div>
    </div>`;
   });
  }
  html+="</div>";
 }
 document.getElementById("menu").innerHTML=html;
}

// ===== CARRITO =====
function chg(id,d){
 carrito[id]+=d;
 if(carrito[id]<0) carrito[id]=0;
 document.getElementById(id).innerText=carrito[id];

 total=0;
 let r="";
 for(let k in carrito){
  total+=carrito[k]*precios[k];
  if(carrito[k]>0) r+=`${carrito[k]} ${k.replace(/_/g," ")}<br>`;
 }
 document.getElementById("total").innerText=total;
 document.getElementById("resumen").innerHTML=r||"<small>No hay productos seleccionados</small>";
}

// ===== WHATSAPP =====
function enviar(){
 if(total===0){alert("Seleccione productos");return;}
 let msg="ðŸ§¾ *Pedido*\n\n";
 for(let k in carrito)
  if(carrito[k]>0) msg+=`â€¢ ${carrito[k]} ${k.replace(/_/g," ")}\n`;
 msg+=`\nðŸ’° Total: $${total}`;
 window.open("https://wa.me/59892663559?text="+encodeURIComponent(msg));
}
</script>

</body>
</html>
