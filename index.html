<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>El Rey de las Empanadas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
 font-family:Arial,sans-serif;
 background:#f4f4f4;
 margin:0;
 padding:10px;
}
h1{
 text-align:center;
 color:#b30000;
 margin-bottom:5px;
}
h1 small{
 display:block;
 font-size:12px;
 color:#555;
}
.section-title{
 background:#b30000;
 color:white;
 padding:8px 12px;
 border-radius:8px;
 margin-bottom:10px;
 font-size:18px;
}
.sub-title{
 font-weight:bold;
 color:#b30000;
 margin:12px 0 6px;
 font-size:15px;
 border-bottom:1px solid #eee;
}
.card{
 background:white;
 padding:15px;
 border-radius:12px;
 margin-bottom:20px;
 box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.item{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:8px 0;
 border-bottom:1px dashed #eee;
}
.item:last-child{border-bottom:none}
.name{
 font-weight:bold;
 font-size:15px;
}
.desc{
 font-size:12px;
 color:#777;
 margin-top:2px;
}
.controls button{
 width:30px;
 height:30px;
 border:none;
 border-radius:6px;
 font-size:18px;
 cursor:pointer;
}
.controls .plus{background:#25D366;color:white;}
.controls .minus{background:#b30000;color:white;}
.total{
 background:white;
 padding:15px;
 border-radius:12px;
 box-shadow:0 3px 8px rgba(0,0,0,.15);
}
button.send{
 width:100%;
 padding:15px;
 background:#25D366;
 color:white;
 font-size:20px;
 border:none;
 border-radius:12px;
 margin-top:10px;
}
small{color:#777}
</style>
</head>

<body>

<h1>ðŸ‘‘ El Rey de las Empanadas
<small>Horario: 17:00 a 23:00 | Lunes cerrado</small>
</h1>

<div id="menu"></div>

<div class="total">
 <div class="section-title">ðŸ›’ Resumen del pedido</div>
 <div id="resumen"><small>No hay productos seleccionados</small></div>
 <p><b>Total:</b> $<span id="total">0</span></p>
 <button class="send" onclick="enviar()">ðŸ“² Enviar pedido</button>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?gid=0&single=true&output=csv";

let carrito = {}, precios = {}, total = 0;

function idify(t){
 return t.replace(/\s+/g,'_').replace(/[^\w]/g,'');
}

/* ===== CSV parser robusto ===== */
function parseCSV(text){
 let rows = [], row = [], cur = "", inside = false;
 for(let c of text){
  if(c === '"') inside = !inside;
  else if(c === ',' && !inside){ row.push(cur); cur = ""; }
  else if(c === '\n' && !inside){ row.push(cur); rows.push(row); row=[]; cur=""; }
  else cur += c;
 }
 row.push(cur); rows.push(row);
 return rows;
}

fetch(CSV_URL)
.then(r => r.text())
.then(text => {
 const rows = parseCSV(text);
 rows.shift(); // encabezado

 const menu = {};

 rows.forEach(c => {
  if(c.length < 6) return;

  const producto = c[0].trim();
  const categoria = c[1].trim();
  const subcat = c[2].trim();
  const precio = parseInt(c[3]);
  const stock = c[4].toLowerCase();
  const desc = c[5].trim();

  if(!producto || isNaN(precio)) return;
  if(stock.includes("no") || stock === "false") return;

  if(!menu[categoria]) menu[categoria] = {};
  if(!menu[categoria][subcat]) menu[categoria][subcat] = [];

  menu[categoria][subcat].push({producto, precio, desc});
 });

 render(menu);
});

function render(menu){
 let html = "";
 Object.keys(menu).forEach(cat=>{
  html += `<div class="card"><div class="section-title">${cat}</div>`;
  Object.keys(menu[cat]).forEach(sub=>{
   html += `<div class="sub-title">${sub}</div>`;
   menu[cat][sub].forEach(p=>{
    const id = idify(p.producto);
    carrito[id]=0; precios[id]=p.precio;
    html += `
    <div class="item">
     <div>
      <div class="name">${p.producto}</div>
      <div class="desc">${p.desc}</div>
      <small>$${p.precio}</small>
     </div>
     <div class="controls">
      <button class="minus" onclick="chg('${id}',-1)">âˆ’</button>
      <span id="${id}">0</span>
      <button class="plus" onclick="chg('${id}',1)">+</button>
     </div>
    </div>`;
   });
  });
  html += `</div>`;
 });
 document.getElementById("menu").innerHTML = html;
}

function chg(id,d){
 carrito[id]=Math.max(0,carrito[id]+d);
 document.getElementById(id).innerText=carrito[id];
 total=0;
 for(let k in carrito) total+=carrito[k]*precios[k];
 document.getElementById("total").innerText=total;
 resumen();
}

function resumen(){
 let r="";
 for(let k in carrito)
  if(carrito[k]>0) r+=`${carrito[k]} ${k.replace(/_/g," ")}<br>`;
 document.getElementById("resumen").innerHTML=r||"<small>No hay productos seleccionados</small>";
}

function enviar(){
 if(total===0){ alert("Seleccione productos"); return; }
 let msg="ðŸ§¾ Pedido:%0A";
 for(let k in carrito)
  if(carrito[k]>0) msg+=`â€¢ ${carrito[k]} ${k.replace(/_/g," ")}%0A`;
 msg+=`%0AðŸ’° Total: $${total}`;
 window.open("https://wa.me/59892663559?text="+msg,"_blank");
}
</script>

</body>
</html>
