<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3xILJU5RgaRD9FvVA-gcr9su-QtH15Qs9JR8MYzHxxO2GZLrCzQvlG_rWCqoTmIx87-BtX9Ki8v6V/pub?output=csv";

let carrito={},precios={},total=0;

// ================= CSV PARSER =================
function parseCSV(text){
 let rows=[],row=[],cur="",q=false;
 for(let i=0;i<text.length;i++){
  let c=text[i],n=text[i+1];
  if(c=='"'&&q&&n=='"'){cur+='"';i++}
  else if(c=='"') q=!q
  else if(c==','&&!q){row.push(cur.trim());cur=""}
  else if(c=='\n'&&!q){row.push(cur.trim());rows.push(row);row=[];cur=""}
  else cur+=c
 }
 row.push(cur.trim());rows.push(row)
 return rows
}

// ================= LOAD =================
fetch(CSV_URL)
.then(r=>r.text())
.then(t=>{
 const rows=parseCSV(t)
 if(rows.length<2){alert("CSV vacío");return}

 // Normalizar headers
 const headers=rows[0].map(h=>h.toLowerCase().trim())

 const idx={
  categoria:headers.indexOf("categoria"),
  subcategoria:headers.indexOf("subcategoria"),
  nombre:headers.indexOf("nombre"),
  descripcion:headers.indexOf("descripcion"),
  precio:headers.indexOf("precio"),
  stock:headers.indexOf("stock")
 }

 // Verificación fuerte
 for(let k in idx){
  if(idx[k]===-1){
   alert("Falta columna en Sheets: "+k)
   return
  }
 }

 const menu={}

 rows.slice(1).forEach(r=>{
  if(!r[idx.nombre]) return
  if(r[idx.stock].toUpperCase()!=="TRUE") return

  let cat=r[idx.categoria]
  let sub=r[idx.subcategoria]||""

  if(!menu[cat]) menu[cat]={}
  if(!menu[cat][sub]) menu[cat][sub]=[]

  menu[cat][sub].push({
   nombre:r[idx.nombre],
   descripcion:r[idx.descripcion],
   precio:parseInt(r[idx.precio])
  })
 })

 if(Object.keys(menu).length===0){
  document.getElementById("menu").innerHTML=
   "<p style='color:red;font-weight:bold'>⚠️ No hay productos con stock</p>"
  return
 }

 render(menu)
})
.catch(e=>{
 console.error(e)
 alert("Error cargando menú")
})

// ================= RENDER =================
function render(menu){
 let html=""
 for(let cat in menu){
  html+=`<div class="card"><div class="section-title">${cat}</div>`
  for(let sub in menu[cat]){
   if(sub) html+=`<div class="sub-title">${sub}</div>`
   menu[cat][sub].forEach(p=>{
    let id=p.nombre.replace(/\s+/g,"_")
    carrito[id]=0
    precios[id]=p.precio
    html+=`
    <div class="item">
     <div>
      <div class="name">${p.nombre}</div>
      <div class="desc">${p.descripcion||""}</div>
      <small>$${p.precio}</small>
     </div>
     <div class="controls">
      <button class="minus" onclick="chg('${id}',-1)">−</button>
      <span id="${id}">0</span>
      <button class="plus" onclick="chg('${id}',1)">+</button>
     </div>
    </div>`
   })
  }
  html+="</div>"
 }
 document.getElementById("menu").innerHTML=html
}

// ================= CART =================
function chg(id,d){
 carrito[id]+=d
 if(carrito[id]<0) carrito[id]=0
 document.getElementById(id).innerText=carrito[id]

 total=0
 let r=""
 for(let k in carrito){
  total+=carrito[k]*precios[k]
  if(carrito[k]>0) r+=`${carrito[k]} ${k.replace(/_/g," ")}<br>`
 }
 document.getElementById("total").innerText=total
 document.getElementById("resumen").innerHTML=r||"<small>No hay productos</small>"
}
</script>
